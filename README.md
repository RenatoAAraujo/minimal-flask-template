# Star Wars API integration

The tutorial assumes that the user's OS is UNIX based, **if not make the appropriate changes and select the correct OS in the documentation**. 
_If running on Windows remember to enable Hyper-V and virtual environments_. 

### Pre Requirements
* [Python 3](https://www.python.org/)

* [python3-pip](https://pypi.org/project/pip/)
```shell
sudo apt-get install python3-pip
```
 
* [Docker](https://docs.docker.com/engine/install/debian/)

Create docker group, _**you'll need to reboot after this**_.
```shell
sudo groupadd docker
sudo usermod -aG docker $USER
```
* [Docker Compose](https://docs.docker.com/compose/install/)

* [git](https://git-scm.com/)

### Git clone
```shell
cd ~/path/to/project/
git clone https://github.com/RenatoAAraujo/minimal-flask-template.git
cd minimal-flask-template
```

### Deploy
First deploy
```shell
docker-compose up --build
```
Regular Deploy
```shell
docker-compose up
```
You're ready to go!

### Live Deployment
>The local variables are contained in the [.env](.env) file, when readying to production deployment make the appropriate changes.
>
>**Make sure that the "APP_ENV" variable is set to "production".**

### Code Linting
The [black](https://pypi.org/project/black/), [isort](https://pypi.org/project/black/) and [pylint](https://pylint.pycqa.org/en/latest/#) libs are installed in the development env, **use the after every commit**.
```shell
python3 clean_code.py
```

### Unit Testing
The [pytest](https://docs.pytest.org/en/7.0.x/contents.html) lib is used forr unit testing.
```shell
python3 run_tests.py
```

### Database
The database is versioned using [flask-migrate](https://flask-migrate.readthedocs.io/en/latest/), **all database changes must be done using it**.
##### migrations
After making the appropriates changes to the view.py, schema.py and models.py files, make a migration by running:
```shell
docker-compose exec api flask db migrate -m"your message"
```
If your column has a default, make sure to add the **server_default** parameter to the column in the migration file, like the example below (**remember that it has to be a string**):
```python
from alembic import op
import sqlalchemy as sa

def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('user', sa.Column('email_verified', sa.Boolean(), nullable=True, server_default="0"))
```
##### migrations head conflict
When migrations head conflict is encountered run the command bellow, it will make a new migration file resolving the conflict.
```shell
python3 db-merge.py
```
##### updating the database
Sometimes a change or a database registry will be made that needs to be reflected in [the application dump file](initdb/dumps/barber_dev.sql.gz), to make a new dump run:
```shell
python3 db-dump.py
```
